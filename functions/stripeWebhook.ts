import { base44 } from '@base44/sdk';\n\nexport default async function stripeWebhook(req, res) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ error: 'Method not allowed' });\n  }\n\n  const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);\n  const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\n  let event;\n\n  try {\n    const sig = req.headers['stripe-signature'];\n    event = stripe.webhooks.constructEvent(req.body, sig, endpointSecret);\n  } catch (err) {\n    console.error('Webhook signature verification failed:', err.message);\n    return res.status(400).json({ error: 'Webhook signature verification failed' });\n  }\n\n  try {\n    switch (event.type) {\n      case 'checkout.session.completed':\n        await handleCheckoutCompleted(event.data.object);\n        break;\n      \n      case 'invoice.payment_succeeded':\n        await handlePaymentSucceeded(event.data.object);\n        break;\n      \n      case 'invoice.payment_failed':\n        await handlePaymentFailed(event.data.object);\n        break;\n      \n      case 'customer.subscription.deleted':\n        await handleSubscriptionCancelled(event.data.object);\n        break;\n      \n      default:\n        console.log(`Unhandled event type: ${event.type}`);\n    }\n\n    res.status(200).json({ received: true });\n  } catch (error) {\n    console.error('Webhook processing error:', error);\n    res.status(500).json({ error: 'Webhook processing failed' });\n  }\n}\n\nasync function handleCheckoutCompleted(session) {\n  const { userId, storeId } = session.metadata;\n  \n  if (!storeId) {\n    console.error('No storeId in session metadata');\n    return;\n  }\n\n  try {\n    // Ativar assinatura\n    const now = new Date();\n    const endDate = new Date();\n    endDate.setMonth(endDate.getMonth() + 1); // +1 mÃªs\n\n    await base44.entities.Store.update(storeId, {\n      subscription_status: 'ACTIVE',\n      subscription_start_at: now.toISOString(),\n      subscription_end_at: endDate.toISOString(),\n      stripe_customer_id: session.customer,\n      stripe_subscription_id: session.subscription,\n      plan_type: getPlanTypeFromPrice(session.amount_total)\n    });\n\n    console.log(`Subscription activated for store ${storeId}`);\n  } catch (error) {\n    console.error('Error activating subscription:', error);\n  }\n}\n\nasync function handlePaymentSucceeded(invoice) {\n  const subscriptionId = invoice.subscription;\n  \n  try {\n    // Buscar loja pela subscription_id\n    const stores = await base44.entities.Store.filter({ \n      stripe_subscription_id: subscriptionId \n    });\n    \n    if (stores.length === 0) {\n      console.error('No store found for subscription:', subscriptionId);\n      return;\n    }\n\n    const store = stores[0];\n    \n    // Renovar assinatura\n    const endDate = new Date();\n    endDate.setMonth(endDate.getMonth() + 1);\n\n    await base44.entities.Store.update(store.id, {\n      subscription_status: 'ACTIVE',\n      subscription_end_at: endDate.toISOString()\n    });\n\n    console.log(`Subscription renewed for store ${store.id}`);\n  } catch (error) {\n    console.error('Error renewing subscription:', error);\n  }\n}\n\nasync function handlePaymentFailed(invoice) {\n  const subscriptionId = invoice.subscription;\n  \n  try {\n    const stores = await base44.entities.Store.filter({ \n      stripe_subscription_id: subscriptionId \n    });\n    \n    if (stores.length === 0) return;\n    \n    const store = stores[0];\n    \n    // Marcar como expirada\n    await base44.entities.Store.update(store.id, {\n      subscription_status: 'EXPIRED'\n    });\n\n    console.log(`Subscription expired for store ${store.id} due to payment failure`);\n  } catch (error) {\n    console.error('Error handling payment failure:', error);\n  }\n}\n\nasync function handleSubscriptionCancelled(subscription) {\n  try {\n    const stores = await base44.entities.Store.filter({ \n      stripe_subscription_id: subscription.id \n    });\n    \n    if (stores.length === 0) return;\n    \n    const store = stores[0];\n    \n    // Marcar como cancelada\n    await base44.entities.Store.update(store.id, {\n      subscription_status: 'CANCELLED'\n    });\n\n    console.log(`Subscription cancelled for store ${store.id}`);\n  } catch (error) {\n    console.error('Error handling subscription cancellation:', error);\n  }\n}\n\nfunction getPlanTypeFromPrice(amountTotal) {\n  // Converter centavos para reais\n  const amount = amountTotal / 100;\n  \n  if (amount <= 97) return 'basic';\n  if (amount <= 197) return 'pro';\n  return 'enterprise';\n}